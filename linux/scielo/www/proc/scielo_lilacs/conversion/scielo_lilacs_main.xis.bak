<IsisScript>

<include>scielo_lilacs/doi/doi.xis</include>

<!-- Common functions -->
<function name="add8" action="replace" tag="3880">
	<field action="import" tag="list">8,880</field>
	<field action="replace" tag="3068"><pft>if l(['TITLE']'LOC='v880*1.9)>0 then ref(['TITLE']l(['TITLE']'LOC='v880*1.9),v68) fi</pft></field>

	<field action="replace" tag="3000"><pft>|../bases-work/|v3068|/lang|</pft></field>

	<field action="statusfile" tag="1091"><pft>v3000|.mst|</pft></field>
	<flow action="jump"><pft>if v1091^s : 'e' then else 'END' fi</pft></flow>

	<label>CHECK_LANGS</label>
	<do task="search">
		<parm name="db"><pft>v3000</pft></parm>
		<parm name="expression"><pft>v880</pft></parm>

		<loop>
			<field action="import" tag="list">8</field>

			<field action="replace" tag="3008"><pft>v8^i</pft></field>
			<field action="replace" tag="3008"><pft>mid(v3008,8,size(v3008))</pft></field>
			<field action="replace" tag="3008"><pft>if p(v3008) then 'http://',mid(v3008,1,instr(v3008,'/')) fi</pft></field>
			
			<field action="replace" tag="8" split="occ"><pft>replace(v8,'cgi-bin/fbpe/fbtext?','scielo.php?script=sci_arttext&'),'&tlng='v40/,
				if p(v601) then
				('Internet^i',v3008[1],v601^f/),
				fi
				if p(v602) then
				('Internet^i',v3008[1],v602^f/),
				fi</pft>
			</field>
			
			<field action="export" tag="list">8</field>
		</loop>
	</do>

	<label>END</label>
	<field action="export" tag="list">8</field>

</function>

<function name="add274" action="replace" tag="3880">
	<field action="import" tag="list">880,881,31/32,131/132</field>
	<field action="replace" tag="7011">../bases-work</field>
	<field action="replace" tag="7012"><pft>|v|v31,|s|v131,|n|v32,|s|v132</pft></field>
	
	<call name="returnDOI"><pft>if p(v881) then v881 else v880 fi</pft></call>
	<field action="replace" tag="274">900</field>
</function>

<section>
	<field action="cgi" tag="4010">debug</field>
	<trace><pft>v4010</pft></trace>

	<!-- Get CGI Parameters -->
	<field action="cgi" tag="4000">dbsource</field>
	<field action="cgi" tag="4001">dbdestination</field>
	<field action="cgi" tag="4002">dbcontrol</field>
	<field action="cgi" tag="4003">from</field>
	<field action="cgi" tag="4004">count</field>
	<field action="cgi" tag="7011">proc_path</field>

	<include>scielo_lilacs/config/sci_cipar.xis</include>

	<!-- criacao das bases: inicio -->
	<field action="statusfile" tag="1091"><pft>v4001'.mst'</pft></field>
	<file action="create" type="database"><pft>if v1091^s : 'e' then else v4001 fi</pft></file>

	<field action="statusfile" tag="1091"><pft>v4002'.mst'</pft></field>
	<file action="create" type="database"><pft>if v1091^s : 'e' then else v4002 fi</pft></file>
	<!-- criacao das bases: fim -->

	<do task="mfnrange">		
		<parm name="db"><pft>v4000</pft></parm>
		<parm name="from"><pft>v4003</pft></parm>
		<parm name="count"><pft>v4004</pft></parm>

		<loop>			
			<field action="import" tag="list">4001/4002,5000</field>
			<field action="replace" tag="5000"><pft>if a(v5000) or v5000='' then '1' else f(val(v5000)+1,1,0)  fi</pft></field>
			<display><pft>v5000/</pft></display>

			<call name="add8"><pft>v880</pft></call>
			<call name="add274"><pft>v880</pft></call>
			<include>scielo_lilacs/conversion/scielo_lilacs.xis</include>
			<field action="export" tag="list">5000</field>
			<do task="update">
				<parm name="db"><pft>v4002</pft></parm>
				<parm name="mfn">New</parm>
				<field action="define" tag="1101">Isis_Lock</field>
				<parm name="lockid">xxx</parm>
				<field action="define" tag="1102">Isis_Status</field>

				<update>
					<field action="import" tag="list">880,30,31,32,131,132,35</field>
					<field action="replace" tag="91"><pft>date</pft></field>
					<write>Unlock</write>
				</update>
			</do>
		</loop>
	</do>
</section>

</IsisScript>
