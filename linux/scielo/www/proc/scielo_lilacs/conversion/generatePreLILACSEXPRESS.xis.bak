<IsisScript>

<include>scielo_lilacs/tools/doi/doi.xis</include>
<include>scielo_lilacs/tools/xis/add.xis</include>
<include>scielo_lilacs/conversion/functions.xis</include>

<section>
	<field action="cgi" tag="4010">debug</field>
	<trace><pft>v4010</pft></trace>

	<!-- Get CGI Parameters -->
	<field action="cgi" tag="4002">scilista</field>
	<field action="cgi" tag="4006">initial_date</field>
	<field action="cgi" tag="4008">allowed</field>
	<field action="cgi" tag="4005">myissue</field>
	<field action="cgi" tag="4013">tempLILACSEXPRESS</field>
	

	<field action="cgi" tag="7011">proc_path</field>
	<field action="cgi" tag="4015">cip</field>

	
	<include>scielo_lilacs/tools/xis/sci_cipar.xis</include>

	<field action="replace" tag="4007">CTRL_ISSUE</field>
	<field action="replace" tag="4009">PRE_LILACS_EXPRESS</field>
	<field action="replace" tag="4014">CTRL_CONVERSION</field>

	<field action="replace" tag="4011">artigo</field>

	
	<field action="replace" tag="5"><pft>cat(v4008)</pft></field>
	<do task="import">
	  	 <parm name="file"><pft>v4002</pft></parm>
	     <parm name="type">RLine</parm>
		 <parm name="delimiter"><pft>x1</pft></parm>

		 <loop>
			<!-- para cada linha da scilista -->
			<flow action="skip"><pft>if a(v1) then 'Quit' fi</pft></flow>
			
			<field action="import" tag="list">5,4005/4014,5200</field>

			<field action="replace" tag="3"><pft>v1,v2</pft></field>
			
			<label>CHECK_ISSUE_HAS_BEEN_ALREADY_DONE</label>			
			<field action="replace" tag="9990"><pft>			
				if l([v4007]v3)>0 then 
					,s(ref([v4007]l([v4007]v3),v90)),				
				fi
			</pft></field>
			<field action="replace" tag="9991"><pft>			
				if v9990='DONE' then ' BEFORE ',s(ref([v4007]l([v4007]v3),v91[last])) fi
				if v9990='EXPORTED' then v9990,' ',s(ref([v4007]l([v4007]v3),v91[last])) fi
			</pft></field>
			<flow action="jump"><pft>if v9990='DONE' or v9990='EXPORTED' then 'REPORT' fi</pft></flow>


			<label>CHECK_ISSUE_QUALIFICATION</label>					
			<field action="replace" tag="9990"><pft>			
				if instr(v5,s(' ',v1,' '))=0  then
					,'NOT_QUALIFIED_BY_TITLE',
				else
					if l([v4005]v3)=0 then 
						,'NOT_VALID_ISSUE' 
					else
						if val(ref([v4005]l([v4005]v3),v65)) < val(v4006) then 
							'NOT_QUALIFIED_BY_DATE'
						else
							,'QUALIFIED',
						fi
					fi
				fi
			</pft></field>
			
			<field action="replace" tag="9999"><pft>
				if v9990='QUALIFIED' then
					if l([v4005]v3)>0 then
						,ref([v4005]l([v4005]v3),v35,s(v36*0.4),s( f(10000+val(v36*4),4,0))*1.4,'^q',v122,'^d',v91[last]),
					fi
				fi
			</pft></field>
			<field action="replace" tag="880"><pft>v9999^*</pft></field>
			<field action="replace" tag="122"><pft>v9999^q</pft></field>
			<field action="replace" tag="65"><pft>
				if v9990='NOT_QUALIFIED_BY_DATE' then
					ref([v4005]l([v4005]v3),v65)
				fi
			</pft></field>
						
			<flow action="jump"><pft>if v9990='QUALIFIED' then else 'CONTROL_ISSUE_STATUS' fi</pft></flow>

			
			
			
			<label>CREATE_LILACS_EXPRESS</label>
			<!-- v5002 = contador de artigos ok por número -->
			<!-- v5003 = resultado de cd artigo por número -->
			<!-- v5200 = resultado do número -->

			<field action="replace" tag="5002">0</field>
			<field action="delete" tag="5003">1</field>
			<field action="replace" tag="5005">0</field>

			<call name="convert_issue">1</call>
			<!-- v5002: convertido com sucesso -->
			<!-- v5005: convertido com sucesso e na base LILACSXP -->
			<field action="replace" tag="125"><pft>v5002</pft></field>
			<field action="replace" tag="126"><pft>v5005</pft></field>
			<field action="replace" tag="9990"><pft>
				if v122=v125 and v122=v126 then 
					,'DONE'
				else
					,if val(v125)>0 then
						,'PARTIALY_DONE'
					fi
				fi
			</pft></field>
			<field action="replace" tag="9991"><pft>
				if v122=v126 then 
					,' NOW'
				fi
			</pft></field>

			<field action="add" tag="5200"><pft>if v9990='QUALIFIED' or v9990='PARTIALY_DONE' then v1,' ',v2,' ',v9990,' ',v125,'/',v122' ',v126,'/',v122/, /* (v5003/) */ fi</pft></field>
		
			<field action="export" tag="list">5200</field>

			

			<label>CONTROL_ISSUE_STATUS</label>
			<do task="update">
				<parm name="db"><pft>v4007</pft></parm>
				<parm name="mfn"><pft>if l([v4007]v3)>0 then f(l([v4007]v3),1,0) else 'New' fi</pft></parm>
				<field action="define" tag="1101">Isis_Lock</field>
				<parm name="lockid">xxx</parm>
				<field action="define" tag="1102">Isis_Status</field>

				<update>
					<field action="import" tag="list">880,1,2,9990,65,122,125,126</field>
					<field action="import" tag="92">9898</field>
					<field action="replace" tag="90"><pft>v9990</pft></field>
					<field action="add" tag="91"><pft>date</pft></field>
					<write>Unlock</write>
				</update>
			</do>
			<file action="close" type="database"><pft>v4007</pft></file>

			<label>REPORT</label>
			<display><pft>v1,' ',v2,' ',			
			,v9990,		
			,if v9990='DONE' OR v9990='EXPORTED' then
				,| |v9991,
				,| |v9999^d,
				,| records=|,v125 
			,else
				if v9990='NOT_QUALIFIED_BY_DATE' then
					,' ',v65, 
				else
					if v9990='QUALIFIED' or v9990='PARTIALY_DONE' then
						,' ',v125,'/',v122 
					fi
				fi,				
			fi/,
			/* (v5003/) */
			</pft></display>
			
		</loop>

		<display><pft>#,if p(v5200) then 'FAILURE: REPROCESS:'/,(v5200/) else 'SUCCESS'/ fi</pft></display>
	</do>

</section>

</IsisScript>
