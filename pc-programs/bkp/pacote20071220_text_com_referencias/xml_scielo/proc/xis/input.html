<IsisScript name="xml_scielo">

	<function name="parameter">
		<display>
			<!--pft>
				'[proc=<proc_file>] [i2x=<i2x_table>] [id=<provid>]'/
			</pft-->	
		</display>
	</function>

	<function name="fixEntities">
		<field action="import" tag="70">70</field>
		<!-- PARA SOLUCIONAR PROBLEMA DE ENTIDADES NÃO SEREM PRESERVADAS DEPOIS DE APLICAR XSL 
		-->
		<!-- affiliation -->
		<field action="replace" tag="70" split="occ">
			<pft>
				(
					if instr(v70^*,'&')>0 then
						,'<![CDATA[',v70^*,']]>'
						if instr(mid(v70,instr(v70,'^'),size(v70)),'&')>0 then
							,replace( mid(v70,instr(v70,'^'),size(v70)),'&','&amp;')
						fi						
					else 						
						if instr(v70,'&')>0 then
							,replace(v70,'&','&amp;'),
						else 						
							,v70,
						fi
					fi/
				)
			</pft>
		</field>
		<field action="export" tag="list">70</field>

		<field action="import" tag="list">10</field>
		<field action="replace" tag="10" split="occ">
			<pft>
				(
					if instr(v10,'&')>0 then
						,replace( v10,'&','&amp;')
					else
						v10
					fi/
				)
			</pft>
		</field>
		<field action="export" tag="list">10</field>
	</function>

	<function name="getAffEmails">
		<!-- FIXED 20040504 
			Roberta Mayumi Takenaka
			Solicitado por Solange email: 20040429
			Inclusão de e-mail no arquivo XML.			
			Função criada para extrair as tags html do campo v70^e
			-->		
		<field action="replace" tag="9071" split="occ">
			<pft>
				(
					if instr(v70^e,'mailto:')>0 then
						,mid(v70^e,instr(v70^e,'mailto:')+ size('mailto:'),size(v70^e))
					else 
						,v70^e
					fi/
				)
			</pft>
		</field>
		<field action="replace" tag="9072" split="occ">
			<pft>
				(
				if instr(v9071,'&#34;')>0 then
					,mid(v9071,1,instr(v9071,'&#34;')-1)
				else 
					,v9071
				fi/
				)
			</pft>
		</field>
		
		
		<field action="export" tag="list">9071/9072</field>
	</function>

<section>
	<trace>xOn</trace>
	<field action="cgi" tag="1001">sci_lista</field>
	<field action="cgi" tag="1002">config</field>
	<field action="cgi" tag="1004">journals</field>
	<field action="cgi" tag="1003">path_db</field>
	<field action="cgi" tag="1005">proc</field>
	<field action="cgi" tag="1006">i2x</field>
	<field action="cgi" tag="1007">id</field>
	<field action="cgi" tag="1008">fst</field>
	<field action="cgi" tag="1009">xsl</field>
	<field action="cgi" tag="1010">xsl_link</field>
	<field action="cgi" tag="1012">doi_conf</field>

	<call name="parameter"><pft>"*"n1,"*"n2,"*"n6,"*"n7</pft></call>
	<field action="export" tag="list">1001/1012</field>

		<!-- LE O ARQUIVO DOI CONFIGURATION -->
		<do task="import">
			<parm name="file"><pft>v1012</pft></parm>
			<parm name="type">RLine</parm>
			<parm name="delimiter"><pft>x1</pft></parm>
			<loop>
				<field action="replace" tag="7001"><pft>v1</pft></field>
				<field action="replace" tag="7002"><pft>v2</pft></field>
				<field action="replace" tag="7003"><pft>v3</pft></field>
				<field action="export" tag="list">7001/7003</field>
			</loop>
			
		</do>
		


	<do task="import">
		 <field action="import" tag="list">1001/1008,2000/2002,6970/6972,7001/7003,1009/1011</field>
	  	 <parm name=file><pft>v1001</pft></parm>
	     <parm name=type><pft>'RLine'</pft></parm>
		 <parm name="delimiter"><pft>x1</pft></parm>
		 <field action="export" tag="list">1001/1008,2000/2002,6970/6972,7001/7003,1009/1011</field>


		 <loop>
		 	<field action="import" tag="list">1001/1008,1009/1011</field>
		 	<field action="replace" tag="2001"><pft>v1</pft></field>
		 	<field action="replace" tag="2002"><pft>v2</pft></field>
		 	<field action="replace" tag="2000"><pft>v3</pft></field>
<parm name="cipar"><pft>'CONFIG.*=',v1002,'.*'/</pft></parm>
<file action="close" type="database"><pft>v1002</pft></file>
			<field action="replace" tag="6969"><pft>ref([v1004]l([v1004]v2001),v1)</pft></field>

		<!-- FIXED 20040504 
			Roberta Mayumi Takenaka
			Solicitado por Solange email: 20040429
			Falta o ano de início de encvio dos dados		
			foi acrescentado mais uma coluna no arquivo journals.seq 
			que corresponde ao valor do ano de início de envio dos dados (v2)
			-->		
			<field action="replace" tag="6970"><pft>ref([v1004]l([v1004]v2001),v2)</pft></field>
			<field action="replace" tag="6971"><pft>ref([v1004]l([v1004]v2001),v3)</pft></field>
			<field action="replace" tag="6972"><pft>ref([v1004]l([v1004]v2001),v4)</pft></field>


		 	<flow action="skip"><pft>if v6969 = '' then 'Next' fi</pft></flow>
			<field action="export" tag="list">1001/1008,2000/2002,6970/6972,7001/7003,1009/1011</field>
			



<file action="close" type="database"><pft>'BASE'</pft></file>



			<do task="search">
				<field action="delete" tag="2">2</field>
				<field action="import" tag="list">1001/1008,2000/2002,6970/6972,7001/7003,1009/1011</field>
				<parm name="db"><pft>v1002</pft></parm>
				<parm name="expression"><pft>v2001</pft></parm>
				<parm name="cipar"><pft>
				 'CORRIGE.PROC=',v1005/
				 'BASE.mst=',v1003,v2001,'\',v2002,'\base\',v2002,'.mst'/
				 'BASE.xrf=',v1003,v2001,'\',v2002,'\base\',v2002,'.xrf'/
				 'BASE.cnt=temp\',v2001,v2002,'.cnt'/
				 'BASE.n01=temp\',v2001,v2002,'.n01'/	
				 'BASE.n02=temp\',v2001,v2002,'.n02'/	
				 'BASE.l01=temp\',v2001,v2002,'.l01'/	
				 'BASE.l02=temp\',v2001,v2002,'.l02'/	
				 'BASE.ifp=temp\',v2001,v2002,'.ifp'/
			     'CORRIGE.PROC=',v1005/
					</pft>

				</parm>

				<field action="define" tag="6969">Isis_Total</field>
				<field action="delete" tag="2">2</field>
					<loop>
					<field action="import" tag="list">2003</field>
					<field action="add" tag="2003"><pft>v2</pft></field>
					<field action="export" tag="list">2003</field>
					</loop>
					<field action="replace" tag="2003"><pft>(| and not secao=|+v2003),'',</pft></field>
					<field action="export" tag="list">1001/1007,2000/2002,6970/6972,7001/7003,2003,1009/1011</field>
				<do task="search">
					<field action="import" tag="list">1001/1007,2000/2002,6970/6972,7001/7003,2003,1009/1011</field>
					<field action="import" tag="list">8888,9999,9003,7777,6666</field>
<!--					
rem FIXED 20040504 
rem	Roberta Mayumi Takenaka
rem Solicitado por Solange email: 20040429
rem Não gerar sempre o arquivo xml rule
rem Solução: alterar a scilista.lst incluindo YES para gerar o arquivo rule
-->			
<!--
rem FIXED 20040504 
rem	Roberta Mayumi Takenaka
rem Substituição do uxt por php, alteração na passagem de parametros para o batch
-->
					<display><pft>'call batch\GeraXSL.bat ',v2001,' ',v2002,' ',v1009,
						if v2000='YES' then
							' 'v1010,
						fi#</pft></display>
					<file action="create" type="output"><pft>'temp\',v1,v2002'.xml'</pft></file>
					<display><pft>'<?xml version="1.0" encoding="UTF-8"?>'/</pft></display>
					<display><pft>'<xml_scielo>'/,</pft></display>
<!-- FIXED 20040504 
			Roberta Mayumi Takenaka
			Solicitado por Solange email: 20040429
			Falta o ano de início de encvio dos dados.			
			-->						
					<display><pft>'<xml_scielo_title><pubmed-control>'/,</pft></display>
					<display><pft>'<start-date>',v6970,'</start-date>'/,</pft></display>
					<display><pft>'<scielo-url>',v6971,'</scielo-url>'/,</pft></display>
					<display><pft>'<doi-prefix>',v6972,'</doi-prefix>'/,</pft></display>
					<display><pft>'</pubmed-control></xml_scielo_title>'/,</pft></display>
					
					<display><pft>'<doi-configuration>'/,</pft></display>
					<display><pft>'<depositor>'/,</pft></display>
					<display><pft>'<name>',v7001,'</name>'/,</pft></display>
					<display><pft>'<email_address>',v7002,'</email_address>'/,</pft></display>
					<display><pft>'</depositor>'/,</pft></display>
					<display><pft>'<doi-prefix>',v7003,'</doi-prefix>'/,</pft></display>
					<display><pft>'</doi-configuration>'/,</pft></display>
					
					<parm name="db"><pft>'BASE'</pft></parm>
					<parm name="expression"><pft>'tipo=h and not secao='v2003</pft></parm>

<!-- FIXED 20040504 
			Roberta Mayumi Takenaka
			trocado gizmo/gizmoXML por gizmo/ans2utf
			para não haver necessidade de usar o batch que converte os acentos em entidades
						
			-->						
					<parm name="gizmo">gizmo/ans2utf,1/12,13/82,83,84,85,70,10,86/999</parm>
					<parm name="isisxml table">
					<pft>
						cat(v1006),
					</pft>
					</parm>
					<field action="export" tag="list">1007</field>

					<loop>

						<field action="import" tag="9">1007</field>
						<!-- FIXED 20040504 
						Roberta Mayumi Takenaka
						Solicitado por Solange email: 20040429
						Inclusão de e-mail no arquivo XML.			
						-->							
						<call name="fixEntities"><pft>(v10/),(v70/)</pft></call>
						<call name="getAffEmails"><pft>(v70/)</pft></call>

						<proc><pft>@CORRIGE.PROC</pft></proc>
						
						<display><isisxml>*</isisxml></display>
					
					</loop>
					<display><pft>'</xml_scielo>'</pft></display>
					<file action=close type=output>*</file>
				</do>
			</do>
		    </loop>
		</do>
</section>
</IsisScript>
